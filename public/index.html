<html>
	<head>
		<title>Ibiza Performance Analyzer</title>
		<link rel="stylesheet" href="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.11.4/themes/redmond/jquery-ui.css">
		<script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.4.min.js"></script>
		<script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.11.4/jquery-ui.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
		<script type="text/javascript" src="lib/jszip.min.js"></script>
		<script type="text/javascript" src="lib/papaparse.min.js"></script>
		<script>
			var DB = [],
				ActiveRecord = null,
				DBFiltered = [],
				Selected = {
					record: null,
					action: null,
					name: null,
					duration: null,
				};
			
			function Output(msg) {
				var m = $("#messages")[0];
				m.innerHTML = m.innerHTML + msg;
			}
			$(function(){
				console.log("Init");
				var fileselect = $("#fileselect")[0],
				filedrag = $("#filedrag")[0],
				submitbutton = $("#submitbutton")[0];
		
				// file select
				fileselect.addEventListener("change", FileSelectHandler, false);
			
				// is XHR2 available?
				var xhr = new XMLHttpRequest();
				if (xhr.upload) {
					// file drop
					filedrag.addEventListener("dragover", FileDragHover, false);
					filedrag.addEventListener("dragleave", FileDragHover, false);
					filedrag.addEventListener("drop", FileSelectHandler, false);
					filedrag.style.display = "block";
					
					// remove submit button
					submitbutton.style.display = "none";
				}
				// file drag hover
				function FileDragHover(e) {
					e.stopPropagation();
					e.preventDefault();
					e.target.className = (e.type == "dragover" ? "hover" : "");
				}
				// file selection
				function FileSelectHandler(e) {
					// cancel event and hover styling
					FileDragHover(e);
					// fetch FileList object
					var files = e.target.files || e.dataTransfer.files;
					// process all File objects
					for (var i = 0, f; f = files[i]; i++) {
						ParseFile(f);
					}
				}
				function ParseFile(file) {
					Output(
						"<p>File information: <strong>" + file.name +
						"</strong> type: <strong>" + file.type +
						"</strong> size: <strong>" + file.size +
						"</strong> bytes</p>"
					);
					if (file.type !== "application/x-zip-compressed") {
					 	Output("<p><strong>ERROR: </strong>Please provide a .zip file.");
						return;
					}
					Output("<p>Unzipping ...</p>");
					var reader = new FileReader();
					reader.onload = function(e) {
						var z = new JSZip(e.target.result);
						$.each(z.files, function(index, zipEntry){
							var content = zipEntry.asText();
							DB = [];
							StartTime = Number.MAX_VALUE;
							Output("<p>Parsing into CSV ...</p>");
							Papa.parse(content, {
								header:true,
								dynamicTyping:true,
								step: function(row) {
									var r = row.data[0],
										stime;
									if (r.actionModifier === "complete") {
										stime = r.clientTime - r.duration;
										if (stime < StartTime) {
											StartTime = stime;
										}
										DB.push({
											action: r.action,
											clientTime: r.clientTime,
											duration: r.duration,
											extension: r.extension,
											name: r.name,
											clientTimeStart: stime
										});
									}
								},
								complete: function() {
									Output("<p>Found "+DB.length+" records.</p>");
									$("#names").val("");
									$("#actions").val("");
									// let user select action
									actionsArray = GetActions(DB);
									$("#actions").autocomplete({
										source: function(req,res) {
											var term = req.term.toLowerCase();
											var rsp = actionsArray.filter(function(val){
												return val.toLowerCase().indexOf(term) >= 0;
											});
											this.element[0]._def = rsp[0];
											res(rsp);											
										},
										select: function(event, ui) {
											event.target._def = ui.item.value;
											$(event.target).val(event.target._def);
											$(event.target).trigger('change');
											SearchNames();
										},
										minLength: 0
									}).on('click', function(e){
										$(this).val("");
										$(this).autocomplete("search","");
									}).on('keydown', function(e){
										if (e.keyCode === 13) {
											$(this).autocomplete("close");
											$(event.target).val(event.target._def);
											$(event.target).trigger('change');
											SearchNames();
										}
									});
								}
							});
						});
					}
					reader.readAsArrayBuffer(file);
				}
				
				function SearchNames() {
					var action = $("#actions").val();
					var namesArray = GetNames(DB,action);
					$("#names").val("");
					$("#names").autocomplete({
						source: function(req,res) {
							var term = req.term.toLowerCase();
							var rsp = namesArray.filter(function(val){
								return val.toLowerCase().indexOf(term) >= 0;
							});
							this.element[0]._def = rsp[0];
							res(rsp);											
						},
						select: function(event, ui) {
							event.target._def = ui.item.value;
							$(event.target).val(event.target._def);
							$(event.target).trigger('change');	
							plot(filterDB(DB,action,event.target._def));
						},
						minLength: 0
					}).on('click', function(e){
						$(this).val("");
						$(this).autocomplete("search","");
					}).on('keydown', function(e){
						if (e.keyCode === 13) {
							$(this).autocomplete("close");
							$(event.target).val(event.target._def);
							$(event.target).trigger('change');
							plot(filterDB(DB,action,event.target._def));
						}
					});
				}
				
				function GetActions(db) {
					var actions = {},
						actionsArray = [];
					db.forEach(function(r) {
						if (actions[r.action]) {
							actions[r.action] += 1;
						} else {
							actions[r.action] = 1;
						}		
					});
					for(var n in actions) {
						actionsArray.push(n);
					}
					return actionsArray.sort();
				}
				
				function GetNames(db,action) {
					var namesArray = [];
					db.forEach(function(r) {
						if (r.action === action) {
							namesArray.push(r.duration+":"+r.name);
						}
					});
					return namesArray.sort(function(a,b){
						var asplit = a.toLowerCase().split(":");
						var bsplit = b.toLowerCase().split(":");
						if (asplit[1] < bsplit[1]) {
							return -1;
						} else if (asplit[1] > bsplit[1]) {
							return 1;
						} else if (parseInt(asplit[0]) < parseInt(bsplit[0])) {
							return -1;
						} else if (parseInt(asplit[0]) > parseInt(bsplit[0])) {
							return 1;
						}
						return 0;
					});
				}
			});
			
			function filterDB(db,action,durname) {
				var name = durname.split(":")[1],
					dur  = parseInt(durname.split(":")[0]);
				
				db.forEach(function(r) {
					if (r.action === action && r.name === name && r.duration === dur) {
						ActiveRecord = r;
					}
				});
				
				DBFiltered = db.filter(function(r) {
					return ActiveRecord.clientTimeStart <= r.clientTime && ActiveRecord.clientTime >= r.clientTimeStart;					
				});

				// adjust times
				// var startTime = Number.MAX_VALUE;
				// data.forEach(function(r){
				// 	if (r.clientTimeStart < startTime) {
				// 		startTime = r.clientTimeStart;
				// 	}
				// });
				var startTime = ActiveRecord.clientTimeStart;
				DBFiltered.forEach(function(r) {
					r.startTime = r.clientTimeStart - startTime;
					r.endTime = Math.min(r.clientTime,ActiveRecord.clientTime+100) - startTime;
				});
				
				return DBFiltered;
			}
			
			function plot(data) {
				var margin = {top: 20, right: 20, bottom: 30, left: 40},
					width = 960 - margin.left - margin.right,
					height = 1000 - margin.top - margin.bottom;

				var x = d3.scale.linear()
					.range([0, width]);
				
				var y = d3.scale.linear()
					.range([height, 0]);
				
				var color = d3.scale.category20();
				
				var xAxis = d3.svg.axis()
					.scale(x)
					.orient("bottom");
				
				var yAxis = d3.svg.axis()
					.scale(y)
					.orient("left");
				
				$("#plot").empty();
				var svg = d3.select("#plot").append("svg")
					.attr("width", width + margin.left + margin.right)
					.attr("height", height + margin.top + margin.bottom)
				.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

				x.domain([0, data[data.length-1].endTime]);
				y.domain([0, data.length]);
				
				svg.append("g")
					.attr("class", "x axis")
					.attr("transform", "translate(0," + height + ")")
					.call(xAxis)
					.append("text")
					.attr("class", "label")
					.attr("x", width)
					.attr("y", -6)
					.style("text-anchor", "end")
					.text("Time (ms)");
				
				svg.append("g")
					.attr("class", "y axis")
					.call(yAxis)
					.append("text")
					.attr("class", "label")
					.attr("transform", "rotate(-90)")
					.attr("y", 6)
					.attr("dy", ".71em")
					.style("text-anchor", "end")
					.text("Trace Count: "+data.length);
				
				svg.selectAll(".range")
					.data(data)
					.enter().append("rect")
					.attr("class", "range")
					.attr("x", function(d) { return x(d.startTime); })
					.attr("y", function(d,i) { return y(i); })
					.attr("width", function(d) { return x((d.duration >= 4)?d.duration:4); })
					.attr("height", 4)
					.style("fill", function(d) { return color(d.name); })
					.append("svg:title")
					.text(function(d) { 
						var tooltip =
						"Action: "+d.action+"\n"
						+"Name: "+d.name+"\n"
						+"Extension: "+d.extension+"\n"
						+"Source: "+d.source+"\n"
						+"Start: "+d.startTime+", Stop: "+d.endTime+" Duration: "+d.duration;
						return tooltip;		  
					});
			}
		</script>
	</head>
	<body>
		<h1>Ibiza Performance Analyzer</h1>
		<form id="upload" action="upload" method="POST" enctype="multipart/form-data">
			<fieldset>
				<legend>Drag and Drop or Upload a Jarvis .zip File</legend>
				<input type="file" id="fileselect" name="fileselect" />
				<div id="filedrag">
					<img id="uploadTarget" src="img/DragDropFile.png" width="20%" height="20%">
				</div>
				<div id="submitbutton">
					<button type="submit">Upload File</button>
				</div>
			</fieldset>
		</form>
		<div id="messages">
			<h3>Status Messages:</h3>
		</div>
		<div id="selections" class="ui-widget">
			<label for="actions">Action: </label>
			<input id="actions" style="width:250px" />
			<label for="names">Name: </label>
			<input id="names" style="width:800px" />
		</div>
		<div id="plot"></div>
	</body>
</html>
